{"id":"gdoc-2id","content_hash":"7e4eb543ffa288420538482f930ea2198735c3600d3963f5c7692595b7a79220","title":"Implement cache management with --clear-cache flag","description":"Implement dual-cache system for extension_api.json at ~/.cache/gdoc/ with binary parsed cache for fast loading.","design":"## Cache Location\n- Use `known-folders` library to get cache directory\n- Cache files in `~/.cache/gdoc/`:\n  - `extension_api.json` - Raw JSON from Godot (source of truth)\n  - `extension_api.parsed` - Binary serialized parsed struct\n\n## Binary Cache Format\n```\n[0-3]   Magic \"GDOC\"\n[4-7]   Version (u32) - bump when struct layout changes\n[8-11]  Checksum/hash of JSON source (u32) - detect if JSON changed\n[12+]   Struct data dump\n```\n\n## Cache Flow\n**Normal run** (`gdoc Node2D`):\n1. Check if `.parsed` exists + valid (magic/version/checksum) → deserialize and use\n2. If `.parsed` invalid/missing, check if `extension_api.json` exists → parse it, create `.parsed`\n3. If JSON also missing → run `godot --dump-extension-api-with-docs`, save JSON, parse, create `.parsed`\n4. Only error if `godot` command not found or fails\n\n**With --clear-cache flag** (`gdoc Node2D --clear-cache`):\n1. Delete `~/.cache/gdoc/extension_api.json`\n2. Delete `~/.cache/gdoc/extension_api.parsed`\n3. Continue with normal lookup (triggers regeneration)\n4. Show \"Cache cleared, regenerating...\" message\n\n## Implementation Tasks\n- Add `known-folders` dependency to build.zig.zon\n- Implement getCacheDir() using known-folders\n- Implement binary cache format with magic header + version + checksum\n- Implement cache validation logic\n- Implement Godot execution: `godot --dump-extension-api-with-docs`\n- Implement atomic file writes (temp + rename)\n- Add --clear-cache flag handling","acceptance_criteria":"- [ ] Cache directory created at correct XDG location using known-folders\n- [ ] `extension_api.json` generated from Godot on first run if missing\n- [ ] Binary `.parsed` cache created with magic header + version + checksum\n- [ ] Cache validation detects stale/invalid cache and regenerates\n- [ ] `--clear-cache` flag deletes both cache files and regenerates\n- [ ] Errors gracefully when Godot not found and cache missing","status":"open","priority":1,"issue_type":"feature","created_at":"2025-11-14T16:06:33.344779+11:00","updated_at":"2025-11-14T16:06:33.344779+11:00","source_repo":"."}
{"id":"gdoc-mqq","content_hash":"cad58516c94234f94fb0855f74f2dfeeaf8e70ffd993c9c4ca8173fad963fef8","title":"Parse extension_api.json into flat StringArrayHashMap","description":"Parse Godot extension API JSON into optimized lookup structure with all symbols in a flat StringArrayHashMap. Convert BBCode docs to Markdown using bbcodez.","design":"## Data Structures\n\n```zig\npub const DocDatabase = struct {\n    // ArrayHashMap: get by key OR by index\n    symbols: std.StringArrayHashMap(DocEntry),\n    allocator: Allocator,\n};\n\npub const DocEntry = struct {\n    name: []const u8,           // \"append\", \"sin\", \"Node2D\"\n    full_path: []const u8,      // \"PackedVectorArray.append\", \"Node2D\"\n    parent_index: ?usize,       // Index into symbols array, null for top-level\n    kind: EntryKind,\n    description: []const u8,    // Markdown (converted from BBCode)\n    signature: ?[]const u8,     // \"fn append(value: Variant)\"\n    members: ?[]usize,          // Indices of members (not strings)\n};\n\npub const EntryKind = enum {\n    builtin_class,\n    class,\n    method,\n    property,\n    constant,\n    enum_value,\n    global_function,\n    operator,\n};\n```\n\n## Flat Namespace Strategy\n\nAll symbols stored in single HashMap:\n- Classes: `\"PackedVectorArray\"` → class entry with `.members` list\n- Methods: `\"PackedVectorArray.append\"` → method entry with signature\n- Properties: `\"Node2D.position\"` → property entry\n- Globals: `\"sin\"` → global function (strip `@GlobalScope.` prefix)\n- Enums: `\"AESContext.Mode\"` → enum entry\n- Enum values: `\"AESContext.Mode.MODE_ECB_ENCRYPT\"` → enum value entry\n\n## @GlobalScope Handling\n\nWhen parsing JSON:\n```zig\nif (std.mem.startsWith(u8, full_name, \"@GlobalScope.\")) {\n    const key = full_name[\"@GlobalScope.\".len..];  // \"sin\"\n    // Store under \"sin\", not \"@GlobalScope.sin\"\n}\n```\n\n## BBCode to Markdown Conversion\n\n- Parse JSON\n- For each description field (BBCode)\n- Use `bbcodez` to convert to Markdown\n- Store Markdown in DocEntry\n- Godot BBCode tags: `[b]`, `[i]`, `[code]`, `[codeblock]`, `[url]`, `[param]`, etc.\n\n## Implementation Tasks\n\n- Define DocDatabase and DocEntry structs\n- Implement JSON parsing for `builtin_classes` array\n- Implement JSON parsing for `classes` array\n- Implement JSON parsing for global scope functions\n- Merge all into single StringArrayHashMap\n- Build parent_index and members relationships\n- Integrate bbcodez for BBCode → Markdown conversion\n- Write unit tests for parsing sample JSON","acceptance_criteria":"- [ ] DocDatabase struct with StringArrayHashMap implemented\n- [ ] Parses builtin_classes from JSON into HashMap\n- [ ] Parses classes from JSON into HashMap\n- [ ] Parses global functions (strips @GlobalScope prefix)\n- [ ] Parent/child relationships stored as indices\n- [ ] Members lists stored as indices (not strings)\n- [ ] All BBCode descriptions converted to Markdown using bbcodez\n- [ ] Unit tests verify parsing of sample classes/methods/properties","status":"open","priority":1,"issue_type":"feature","created_at":"2025-11-14T16:06:55.715924+11:00","updated_at":"2025-11-14T16:06:55.715924+11:00","source_repo":"."}
